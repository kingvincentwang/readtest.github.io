<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆèªå­¸ç¿’éº»å°‡ - å¯“æ•™æ–¼æ¨‚ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        // è·³éå‹•ä½œ
        function skipAction() {
            gameState.phase = 'normal';
            // ä¸‹ä¸€ä½ç©å®¶
            gameState.currentPlayer = (gameState.lastDiscardedPlayer + 1) % 4;
            updateDisplay();
            
            // AI è‡ªå‹•é€²è¡Œ
            if (gameState.currentPlayer !== 0) {
                setTimeout(() => {
                    aiPlay();
                }, 1000);
            }
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #2d5016 0%, #4a7c2a 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .game-container {
            width: 95vw;
            height: 95vh;
            background: #1a3d0a;
            border-radius: 20px;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border: 3px solid #8B4513;
        }

        .center-area {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 320px;
            height: 320px;
            background: #0f2607;
            border-radius: 15px;
            border: 2px solid #654321;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .game-info {
            color: #FFD700;
            text-align: center;
            margin-bottom: 15px;
        }

        .dice-area {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .dice {
            width: 40px;
            height: 40px;
            background: white;
            border: 2px solid #333;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            font-weight: bold;
            position: relative;
        }

        .dice-dots {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            width: 30px;
            height: 30px;
            gap: 2px;
        }

        .dot {
            width: 6px;
            height: 6px;
            background: #333;
            border-radius: 50%;
        }

        .controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn {
            padding: 8px 12px;
            background: #8B4513;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .btn:hover {
            background: #A0522D;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        .player-area {
            position: absolute;
        }

        .player-bottom {
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
        }

        .player-top {
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
        }

        .player-left {
            left: 20px;
            top: 40%;
            transform: translateY(-50%);
            height: 60%;
            width: 160px;
        }

        .player-right {
            right: 20px;
            top: 40%;
            transform: translateY(-50%);
            height: 60%;
            width: 160px;
        }

        .player-name {
            color: #FFD700;
            text-align: center;
            margin-bottom: 8px;
            font-weight: bold;
            font-size: 14px;
        }

        .hand-tiles {
            display: flex;
            gap: 3px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }

        .player-left .hand-tiles,
        .player-right .hand-tiles {
            flex-direction: column;
            align-items: center;
            gap: 0px;
        }

        .melds {
            display: flex;
            gap: 1px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 8px;
            max-height: 60px;
            overflow: visible;
        }

        .player-left .melds,
        .player-right .melds {
            flex-direction: column;
            align-items: center;
            gap: 0px;
        }

        .meld {
            display: flex;
            gap: 0px;
            background: rgba(255, 215, 0, 0.2);
            border: 1px solid #FFD700;
            border-radius: 4px;
            padding: 1px;
        }

        .player-left .meld,
        .player-right .meld {
            flex-direction: column;
            gap: -1px;
        }

        .tile {
            width: 50px;
            height: 70px;
            background: linear-gradient(145deg, #f8f8f8, #e0e0e0);
            border: 2px solid #999;
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            position: relative;
            padding: 3px;
        }

        .meld .tile {
            width: 42px;
            height: 58px;
            cursor: default;
            font-size: 8px;
        }

        .player-left .tile,
        .player-right .tile {
            width: 35px;
            height: 50px;
            font-size: 8px;
            transform: rotate(90deg);
            transform-origin: center;
            margin: -3px 0;
        }

        .player-left .tile:hover,
        .player-right .tile:hover {
            transform: rotate(90deg) translateX(-8px);
            z-index: 10;
        }

        .player-left .meld .tile,
        .player-right .meld .tile {
            width: 30px;
            height: 44px;
            font-size: 7px;
            transform: rotate(90deg);
            transform-origin: center;
        }

        .player-left .meld .tile:hover,
        .player-right .meld .tile:hover {
            transform: rotate(90deg);
        }

        .tile:hover {
            transform: translateY(-6px);
            box-shadow: 2px 6px 8px rgba(0,0,0,0.4);
        }

        .meld .tile:hover {
            transform: none;
        }

        .tile.selected {
            background: linear-gradient(145deg, #FFD700, #FFA500);
            transform: translateY(-10px);
            border-color: #FF6347;
        }

        .tile-back {
            background: linear-gradient(145deg, #27AE60, #229954);
            color: #FFD700;
            font-size: 14px;
            font-weight: bold;
        }

        .tile-symbol {
            font-size: 12px;
            line-height: 0.9;
            margin-bottom: 2px;
            font-weight: bold;
        }

        .player-left .tile-symbol,
        .player-right .tile-symbol {
            font-size: 9px;
        }

        .meld .tile-symbol {
            font-size: 9px;
        }

        .player-left .meld .tile-symbol,
        .player-right .meld .tile-symbol {
            font-size: 7px;
        }

        .tile-number {
            font-size: 12px;
            font-weight: bold;
            line-height: 0.9;
        }

        .player-left .tile-number,
        .player-right .tile-number {
            font-size: 9px;
        }

        .meld .tile-number {
            font-size: 9px;
        }

        .player-left .meld .tile-number,
        .player-right .meld .tile-number {
            font-size: 7px;
        }

        .discarded-tiles {
            position: absolute;
            top: 35%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 340px;
            height: 120px;
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
            justify-content: center;
            align-items: flex-start;
            overflow: hidden;
        }

        .discarded-tile {
            width: 32px;
            height: 44px;
            background: linear-gradient(145deg, #e8e8e8, #c8c8c8);
            border: 1px solid #888;
            border-radius: 3px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 6px;
            font-weight: bold;
            padding: 2px;
        }

        .discarded-tile.latest {
            border: 2px solid #FF6347;
            background: linear-gradient(145deg, #ffebee, #ffcdd2);
        }

        .discarded-symbol {
            font-size: 7px;
            line-height: 0.9;
            font-weight: bold;
        }

        .discarded-number {
            font-size: 7px;
            font-weight: bold;
            line-height: 0.9;
        }

        .current-player {
            border: 3px solid #FFD700;
            border-radius: 12px;
            padding: 8px;
            background: rgba(255, 215, 0, 0.1);
        }

        .game-status {
            position: absolute;
            top: 10px;
            right: 150px;
            color: #FFD700;
            background: rgba(0,0,0,0.7);
            padding: 12px;
            border-radius: 8px;
            font-size: 18px;
            max-width: 180px;
            z-index: 100;
        }

        .tile-count {
            font-size: 16px;
            color: #CCC;
            margin-top: 5px;
            text-align: center;
        }

        .action-buttons {
            position: fixed;
            bottom: 180px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            background: rgba(0,0,0,0.95);
            padding: 15px 20px;
            border-radius: 12px;
            border: 3px solid #FFD700;
            z-index: 1000;
            box-shadow: 0 8px 25px rgba(0,0,0,0.6);
        }

        .action-btn {
            padding: 12px 18px;
            font-size: 14px;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn.chi {
            background: linear-gradient(145deg, #27AE60, #2ECC71);
            color: white;
        }

        .action-btn.pon {
            background: linear-gradient(145deg, #E74C3C, #C0392B);
            color: white;
        }

        .action-btn.kan {
            background: linear-gradient(145deg, #8E44AD, #9B59B6);
            color: white;
        }

        .action-btn.skip {
            background: linear-gradient(145deg, #95A5A6, #7F8C8D);
            color: white;
        }

        .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

        .hidden {
            display: none !important;
        }

        /* ç‰Œé¢é¡è‰² */
        .man { color: #000; }
        .pin { color: #E74C3C; }
        .sou { color: #27AE60; }
        .honor { color: #8E44AD; }

        /* ç‰¹æ®Šç‰Œé¢æ¨£å¼ */
        .tile.man {
            background: linear-gradient(145deg, #fff, #f5f5f5);
        }
        .tile.pin {
            background: linear-gradient(145deg, #ffebee, #ffcdd2);
        }
        .tile.sou {
            background: linear-gradient(145deg, #e8f5e8, #c8e6c9);
        }
        .tile.honor {
            background: linear-gradient(145deg, #f3e5f5, #e1bee7);
        }

        .wind-indicator {
            position: absolute;
            font-size: 24px;
            color: #FFD700;
            font-weight: bold;
            z-index: 50;
        }

        .wind-east { top: 30px; right: 50px; }
        .wind-south { bottom: 30px; right: 30px; }
        .wind-west { bottom: 30px; left: 30px; }
        .wind-north { top: 30px; left: 30px; }

        .message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            color: #FFD700;
            padding: 20px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            z-index: 1000;
            border: 2px solid #FFD700;
        }

        .idiom-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .idiom-content {
            background: linear-gradient(145deg, #fff, #f0f0f0);
            padding: 30px;
            border-radius: 15px;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border: 3px solid #FFD700;
        }

        .idiom-title {
            font-size: 30px;
            color: #E74C3C;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .idiom-explanation {
            font-size: 16px;
            color: #2C3E50;
            line-height: 1.6;
            margin-bottom: 25px;
            text-align: left;
        }

        .idiom-close {
            background: linear-gradient(145deg, #E74C3C, #C0392B);
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }

        .firework {
            position: fixed;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 3000;
        }

        .firework-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2500;
        }

        @keyframes explode {
            0% {
                transform: scale(0);
                opacity: 1;
            }
            100% {
                transform: scale(1);
                opacity: 0;
            }
        }

        @keyframes sparkle {
            0%, 100% {
                opacity: 0;
                transform: scale(0);
            }
            50% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .celebration-text {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.8);
            z-index: 3500;
            animation: bounce 0.6s ease-in-out infinite alternate;
        }

        @keyframes bounce {
            from {
                transform: translate(-50%, -50%) scale(1);
            }
            to {
                transform: translate(-50%, -50%) scale(1.1);
            }
        }

        .win-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,215,0,0.3) 0%, rgba(231,76,60,0.1) 100%);
            z-index: 2000;
            animation: fadeInOut 3s ease-in-out;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- é¢¨ä½æŒ‡ç¤º -->
        <div class="wind-indicator wind-east">æ±</div>
        <div class="wind-indicator wind-south">å—</div>
        <div class="wind-indicator wind-west">è¥¿</div>
        <div class="wind-indicator wind-north">åŒ—</div>

        <!-- éŠæˆ²ç‹€æ…‹ -->
        <div class="game-status">
            <div>ğŸ² å±€æ•¸: <span id="round">æ±ä¸€å±€</span></div>
            <div>ğŸ€„ å‰©é¤˜: <span id="remaining-tiles">136</span>å¼µ</div>
            <div>ğŸ‘¤ ç•¶å‰: <span id="current-turn">ç©å®¶</span></div>
            <div>ğŸ¯ ç‹€æ…‹: <span id="game-phase">æ­£å¸¸å›åˆ</span></div>
        </div>

        <!-- ä¸­å¤®å€åŸŸ -->
        <div class="center-area">
            <div class="game-info">
                <h3>ğŸ“– æˆèªå­¸ç¿’éº»å°‡ ğŸ“–</h3>
                <p>å­¸æˆèªâ€§çŸ¥å…¸æ•…â€§æ¨‚è¶£å¤š</p>
            </div>
            <div class="dice-area">
                <div class="dice" id="dice1">
                    <div class="dice-dots" id="dice1-dots"></div>
                </div>
                <div class="dice" id="dice2">
                    <div class="dice-dots" id="dice2-dots"></div>
                </div>
            </div>
            <div class="controls">
                <button class="btn" onclick="rollDice()">ğŸ² æ“²éª°å­</button>
                <button class="btn" onclick="newGame()">ğŸ”„ æ–°å±€</button>
                <button class="btn" onclick="drawTile()" id="draw-btn">ğŸ€„ æŠ“ç‰Œ</button>
                <button class="btn" onclick="discardSelected()" id="discard-btn">ğŸ—‘ï¸ æ‰“ç‰Œ</button>
                <button class="btn" onclick="checkPlayerWin()" id="win-btn" style="background: #e74c3c;">ğŸ‰ èƒ¡ç‰Œ</button>
            </div>
        </div>

        <!-- æ£„ç‰Œå€ -->
        <div class="discarded-tiles" id="discarded-tiles"></div>

        <!-- å‹•ä½œæŒ‰éˆ• -->
        <div class="action-buttons hidden" id="action-buttons">
            <button class="action-btn chi hidden" id="chi-btn" onclick="performChi()">ğŸƒ åƒ</button>
            <button class="action-btn pon hidden" id="pon-btn" onclick="performPon()">ğŸ‘Š ç¢°</button>
            <button class="action-btn kan hidden" id="kan-btn" onclick="performKan()">ğŸ’¥ æ§“</button>
            <button class="action-btn skip" onclick="skipAction()">â­ï¸ è·³é</button>
        </div>

        <!-- ç©å®¶å€åŸŸ -->
        <div class="player-area player-bottom current-player" id="player-0">
            <div class="player-name">ğŸ® ç©å®¶ (æ‚¨)</div>
            <div class="melds" id="melds-0"></div>
            <div class="hand-tiles" id="hand-0"></div>
            <div class="tile-count">æ‰‹ç‰Œ: <span id="count-0">13</span>å¼µ | å‰¯éœ²: <span id="meld-count-0">0</span>çµ„</div>
        </div>

        <div class="player-area player-top" id="player-2">
            <div class="player-name">ğŸ¤– ç©å®¶ 3</div>
            <div class="melds" id="melds-2"></div>
            <div class="hand-tiles" id="hand-2"></div>
            <div class="tile-count">æ‰‹ç‰Œ: <span id="count-2">13</span>å¼µ | å‰¯éœ²: <span id="meld-count-2">0</span>çµ„</div>
        </div>

        <div class="player-area player-left" id="player-3">
            <div class="player-name">ğŸ¤– ç©å®¶ 4</div>
            <div class="melds" id="melds-3"></div>
            <div class="hand-tiles" id="hand-3"></div>
            <div class="tile-count">æ‰‹ç‰Œ: <span id="count-3">13</span>å¼µ | å‰¯éœ²: <span id="meld-count-3">0</span>çµ„</div>
        </div>

        <div class="player-area player-right" id="player-1">
            <div class="player-name">ğŸ¤– ç©å®¶ 2</div>
            <div class="melds" id="melds-1"></div>
            <div class="hand-tiles" id="hand-1"></div>
            <div class="tile-count">æ‰‹ç‰Œ: <span id="count-1">13</span>å¼µ | å‰¯éœ²: <span id="meld-count-1">0</span>çµ„</div>
        </div>
    </div>

    <script>
        // éŸ³æ•ˆç³»çµ±
        class SoundSystem {
            constructor() {
                this.audioContext = null;
                this.initAudioContext();
            }

            initAudioContext() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.log('Web Audio API ä¸æ”¯æ´');
                }
            }

            // å‰µå»ºéŸ³èª¿
            createTone(frequency, duration, volume = 0.3, type = 'sine') {
                if (!this.audioContext) return;

                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);

                oscillator.frequency.value = frequency;
                oscillator.type = type;

                gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(volume, this.audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + duration);

                oscillator.start(this.audioContext.currentTime);
                oscillator.stop(this.audioContext.currentTime + duration);
            }

            // å‰µå»ºè¤‡åˆéŸ³æ•ˆ
            createComplexSound(frequencies, duration, volume = 0.2) {
                frequencies.forEach((freq, index) => {
                    setTimeout(() => {
                        this.createTone(freq, duration / frequencies.length, volume);
                    }, index * (duration * 1000 / frequencies.length));
                });
            }

            // æ“²éª°å­éŸ³æ•ˆ
            playDiceSound() {
                this.createComplexSound([200, 300, 250, 350], 0.6, 0.3);
            }

            // æŠ“ç‰ŒéŸ³æ•ˆ
            playDrawSound() {
                this.createTone(440, 0.2, 0.25, 'triangle');
            }

            // æ‰“ç‰ŒéŸ³æ•ˆ
            playDiscardSound() {
                this.createTone(330, 0.3, 0.3, 'square');
            }

            // åƒç‰ŒéŸ³æ•ˆ
            playChiSound() {
                this.createComplexSound([523, 659, 784], 0.8, 0.3);
            }

            // ç¢°ç‰ŒéŸ³æ•ˆ
            playPonSound() {
                this.createComplexSound([349, 349, 349], 0.6, 0.4);
            }

            // æ§“ç‰ŒéŸ³æ•ˆ
            playKanSound() {
                this.createComplexSound([262, 330, 392, 523], 1.0, 0.35);
            }

            // æ–°å±€éŸ³æ•ˆ
            playNewGameSound() {
                this.createComplexSound([523, 659, 784, 1047], 1.2, 0.3);
            }

            // èƒ¡ç‰ŒéŸ³æ•ˆ
            playWinSound() {
                // å‹åˆ©éŸ³æ•ˆåºåˆ—
                const winSequence = [523, 659, 784, 1047, 1319];
                winSequence.forEach((freq, index) => {
                    setTimeout(() => {
                        this.createTone(freq, 0.4, 0.4, 'sine');
                    }, index * 200);
                });
                
                // é¡å¤–çš„å’Œå¼¦
                setTimeout(() => {
                    this.createTone(523, 2.0, 0.2, 'sine');
                    this.createTone(659, 2.0, 0.2, 'sine');
                    this.createTone(784, 2.0, 0.2, 'sine');
                }, 1000);
            }
        }

        // ç…™ç«ç‰¹æ•ˆç³»çµ±
        class FireworkSystem {
            constructor() {
                this.container = null;
                this.createContainer();
            }

            createContainer() {
                this.container = document.createElement('div');
                this.container.className = 'firework-container';
                document.body.appendChild(this.container);
            }

            // å‰µå»ºå–®å€‹ç…™ç«
            createFirework(x, y, color) {
                const particleCount = 15;
                const particles = [];

                for (let i = 0; i < particleCount; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'firework';
                    particle.style.backgroundColor = color;
                    particle.style.left = x + 'px';
                    particle.style.top = y + 'px';
                    
                    const angle = (i / particleCount) * Math.PI * 2;
                    const velocity = 50 + Math.random() * 50;
                    const lifetime = 1000 + Math.random() * 500;

                    this.container.appendChild(particle);
                    particles.push(particle);

                    // å‹•ç•«ç²’å­
                    this.animateParticle(particle, angle, velocity, lifetime);
                }

                return particles;
            }

            // å‹•ç•«ç²’å­
            animateParticle(particle, angle, velocity, lifetime) {
                const startTime = Date.now();
                const initialX = parseInt(particle.style.left);
                const initialY = parseInt(particle.style.top);

                const animate = () => {
                    const elapsed = Date.now() - startTime;
                    const progress = elapsed / lifetime;

                    if (progress >= 1) {
                        if (this.container.contains(particle)) {
                            this.container.removeChild(particle);
                        }
                        return;
                    }

                    const distance = velocity * progress;
                    const gravity = 100 * progress * progress;
                    
                    const x = initialX + Math.cos(angle) * distance;
                    const y = initialY + Math.sin(angle) * distance + gravity;

                    particle.style.left = x + 'px';
                    particle.style.top = y + 'px';
                    particle.style.opacity = 1 - progress;
                    particle.style.transform = `scale(${1 - progress * 0.5})`;

                    requestAnimationFrame(animate);
                };

                animate();
            }

            // ç™¼å°„å¤šå€‹ç…™ç«
            launchFireworks() {
                const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8'];
                const fireworkCount = 8;

                for (let i = 0; i < fireworkCount; i++) {
                    setTimeout(() => {
                        const x = 200 + Math.random() * (window.innerWidth - 400);
                        const y = 100 + Math.random() * 200;
                        const color = colors[Math.floor(Math.random() * colors.length)];
                        
                        this.createFirework(x, y, color);
                    }, i * 300);
                }
            }

            // å‰µå»ºæ…¶ç¥æ•ˆæœ
            celebrate() {
                // å‰µå»ºèƒŒæ™¯è¦†è“‹å±¤
                const overlay = document.createElement('div');
                overlay.className = 'win-overlay';
                document.body.appendChild(overlay);

                // å‰µå»ºæ…¶ç¥æ–‡å­—
                const celebrationText = document.createElement('div');
                celebrationText.className = 'celebration-text';
                celebrationText.textContent = 'ğŸŠ æ­å–œèƒ¡ç‰Œ ğŸŠ';
                document.body.appendChild(celebrationText);

                // ç™¼å°„ç…™ç«
                this.launchFireworks();

                // æ¸…ç†æ•ˆæœ
                setTimeout(() => {
                    if (document.body.contains(overlay)) {
                        document.body.removeChild(overlay);
                    }
                    if (document.body.contains(celebrationText)) {
                        document.body.removeChild(celebrationText);
                    }
                }, 3000);
            }
        }

        // åˆå§‹åŒ–éŸ³æ•ˆå’Œç‰¹æ•ˆç³»çµ±
        const soundSystem = new SoundSystem();
        const fireworkSystem = new FireworkSystem();
        const idiomExplanations = {
            'ä¸€å¸†é¢¨é †': 'æ¯”å–»èƒ½å¤ æ¯«ä¸è²»åŠ›åœ°å‹åˆ©å®ŒæˆæŸäº‹æƒ…ï¼Œæˆ–äº‹æƒ…èƒ½å¤ é †åˆ©é€²è¡Œã€‚',
            'äºŒé¾æˆ²ç ': 'å…©æ¢é¾ç›¸å°ï¼Œæˆ²ç©è‘—ä¸€é¡†å¯¶ç ã€‚æ¯”å–»æŠ€è—é«˜è¶…æˆ–å‹¢åŠ›ç›¸ç•¶ã€‚',
            'ä¸‰ç¾Šé–‹æ³°': 'ã€Šæ˜“ç¶“ã€‹ç¨±çˆ»é€£çš„ç‚ºé™½å¦ï¼Œæ–·çš„ç‚ºé™°çˆ»ï¼Œæ­£æœˆç‚ºæ³°å¦ï¼Œä¸‰é™½ç”Ÿæ–¼ä¸‹ã€‚æ¯”å–»å†¬å»æ˜¥ä¾†ï¼Œè¬è±¡æ›´æ–°ã€‚',
            'å››å­£å¹³å®‰': 'ä¸€å¹´å››å­£éƒ½å¹³å¹³å®‰å®‰ï¼Œæ²’æœ‰ç½ç¦ã€‚',
            'äº”ç¦è‡¨é–€': 'äº”ç¨®ç¦æ°£åŒæ™‚é™è‡¨ã€‚æ¯”å–»é‹æ°£æ¥µå¥½ã€‚',
            'å…­å…­å¤§é †': 'å½¢å®¹ä¸€åˆ‡é †åˆ©ï¼Œå‰ç¥¥å¦‚æ„ã€‚',
            'ä¸ƒæ˜Ÿé«˜ç…§': 'åŒ—æ–—ä¸ƒæ˜Ÿé«˜é«˜ç…§è€€ã€‚æ¯”å–»å—åˆ°å¹¸é‹æ˜Ÿçš„ç…§è€€ï¼Œé‹æ°£å¾ˆå¥½ã€‚',
            'å…«æ–¹ä¾†è²¡': 'å¾å››é¢å…«æ–¹èšé›†è²¡å¯Œã€‚æ¯”å–»è²¡æºå»£é€²ã€‚',
            'ä¹ä¹æ­¸ä¸€': 'ç¶“éå¤šæ¬¡çš„è®ŠåŒ–æˆ–è½‰æŠ˜ï¼Œæœ€çµ‚å›åˆ°åŸä¾†çš„ç‹€æ…‹ã€‚',
            
            'ä¸€å…ƒå¾©å§‹': 'æ–°çš„ä¸€å¹´é–‹å§‹ã€‚ä¹Ÿæ¯”å–»äº‹æƒ…é‡æ–°é–‹å§‹ã€‚',
            'äºŒè©±ä¸èªª': 'ä¸èªªä»»ä½•åˆ¥çš„è©±ã€‚æŒ‡ç«‹å³è¡Œå‹•ã€‚',
            'ä¸‰ç”Ÿæœ‰å¹¸': 'ä¸‰ä¸–éƒ½å¾ˆå¹¸é‹ã€‚æ¯”å–»éå¸¸å¹¸é‹ã€‚',
            'å››é€šå…«é”': 'å››é¢å…«æ–¹éƒ½æœ‰è·¯å¯é€šã€‚å½¢å®¹äº¤é€šæ¥µä¾¿åˆ©ã€‚',
            'äº”ç©€è±ç™»': 'äº”ç©€éƒ½ç²å¾—è±æ”¶ã€‚æ³›æŒ‡è¾²ä½œç‰©è±æ”¶ã€‚',
            'å…­åˆåŒæ˜¥': 'å…­åˆæŒ‡å¤©åœ°å’Œæ±è¥¿å—åŒ—å››æ–¹ï¼Œå³å¤©ä¸‹ï¼›æ˜¥ï¼Œæ˜¥å­£ã€‚æŒ‡å¤©ä¸‹éƒ½å……æ»¿äº†æ˜¥æ„ã€‚',
            'ä¸ƒç¦é½Šå¤©': 'ä¸ƒç¨®ç¦æ°£éƒ½é”åˆ°å¤©çš„é«˜åº¦ã€‚æ¯”å–»ç¦æ°£æ¥µå¤§ã€‚',
            'å…«é¢ç²ç“': 'åŸæŒ‡çª—æˆ¶æ˜äº®è»’æ•ï¼Œå¾Œç”¨ä¾†å½¢å®¹äººè™•ä¸–åœ“æ»‘ï¼Œå¾…äººæ¥ç‰©å…«é¢è¨å¥½ã€‚',
            'ä¹éœ„é›²å¤–': 'åœ¨ä¹å±¤å¤©çš„å¤–é¢ã€‚æ¯”å–»éå¸¸é«˜é çš„åœ°æ–¹æˆ–å®Œå…¨æƒ³åƒä¸åˆ°çš„åœ°æ–¹ã€‚',
            
            'ä¸€ç®­é›™éµ°': 'åŸæŒ‡å°„ç®­æŠ€è¡“é«˜è¶…ï¼Œä¸€ç®­å°„ä¸­å…©éš»é›•ã€‚å¾Œæ¯”å–»åšä¸€ä»¶äº‹é”åˆ°å…©å€‹ç›®çš„ã€‚',
            'äºŒäººåŒå¿ƒ': 'æ¯”å–»åªè¦å…©å€‹äººä¸€æ¢å¿ƒï¼Œå°±èƒ½ç™¼æ®å¾ˆå¤§çš„åŠ›é‡ã€‚',
            'ä¸‰æ€è€Œè¡Œ': 'åšäº‹å‰è¦åå¾©è€ƒæ…®ã€‚',
            'å››æµ·å‡å¹³': 'æŒ‡å¤©ä¸‹å¤ªå¹³ã€‚',
            'äº”å½©ç¹½ç´›': 'æŒ‡é¡è‰²ç¹å¤šï¼Œè‰²å½©ç¹é›œã€‚',
            'å…­è—ç²¾é€š': 'æŒ‡å°å…­ç¨®æŠ€è—éƒ½å¾ˆç²¾é€šã€‚å…­è—ï¼šç¦®ã€æ¨‚ã€å°„ã€å¾¡ã€æ›¸ã€æ•¸ã€‚',
            'ä¸ƒç«…ç²ç“': 'å½¢å®¹è°æ˜éˆå·§ã€‚ç›¸å‚³å¿ƒæœ‰ä¸ƒç«…ï¼Œæ•…ç¨±ã€‚',
            'å…«æ–—ä¹‹æ‰': 'æ¯”å–»äººæ¥µæœ‰æ‰è¯ã€‚',
            'ä¹å¤©æ”¬æœˆ': 'åˆ°å¤©çš„æœ€é«˜è™•å»æ‘˜æœˆã€‚å¸¸å½¢å®¹å£¯å¿—è±ªæƒ…ã€‚',
            
            'æ±é¢¨å¾—æ„': 'èˆŠæŒ‡è€ƒä¸­é€²å£«ã€‚å¾Œå¸¸ç”¨ä»¥ç¨±é€²å£«åŠç¬¬ã€‚',
            'å—å±±å£½æ¯”': 'æ¯”å–»äººå£½å‘½æ¥µé•·ã€‚',
            'è¥¿çª—å‰ªç‡­': 'åŸæŒ‡æ€å¿µé æ–¹å¦»å­ï¼Œç›¼æœ›ç›¸èšå¤œèªã€‚å¾Œæ³›æŒ‡è¦ªå‹èšè«‡ã€‚',
            'åŒ—æ–—æŒ‡è·¯': 'æ¯”å–»èƒ½æŒ‡å¼•æ–¹å‘çš„äººæˆ–äº‹ç‰©ã€‚',
            'ä¸­æµç ¥æŸ±': 'å°±åƒå±¹ç«‹åœ¨é»ƒæ²³æ€¥æµä¸­çš„ç ¥æŸ±å±±ä¸€æ¨£ã€‚æ¯”å–»å …å¼·ç¨ç«‹çš„äººèƒ½åœ¨å‹•è•©çš„ç’°å¢ƒä¸­èµ·æ”¯æŸ±ä½œç”¨ã€‚',
            'ç™¼æšå…‰å¤§': 'ç™¼å±•å’Œæé«˜ï¼Œä½¿æ›´åŠ å®Œå–„æˆ–å‰å¤§ã€‚',
            'ç™½ç’§ç„¡ç‘•': 'æ½”ç™½çš„ç¾ç‰ä¸Šé¢æ²’æœ‰ä¸€é»å°æ–‘ã€‚æ¯”å–»äººæˆ–äº‹ç‰©å®Œç¾ç„¡ç¼ºã€‚'
        };

        // é¡¯ç¤ºæˆèªè§£é‡‹
        function showIdiomExplanation(tile) {
            const explanation = idiomExplanations[tile.symbol];
            if (!explanation) return;
            
            const modal = document.createElement('div');
            modal.className = 'idiom-modal';
            modal.innerHTML = `
                <div class="idiom-content" onclick="event.stopPropagation()">
                    <h3 class="idiom-title">${tile.symbol}</h3>
                    <p class="idiom-explanation">${explanation}</p>
                    <button class="idiom-close" onclick="closeIdiomModal()">çŸ¥é“äº†</button>
                </div>
            `;
            
            // é»æ“Šå½ˆçª—å¤–éƒ¨ä¹Ÿèƒ½é—œé–‰
            modal.onclick = (e) => {
                if (e.target === modal) {
                    closeIdiomModal();
                }
            };
            
            document.body.appendChild(modal);
            
            // 3ç§’å¾Œè‡ªå‹•é—œé–‰
            setTimeout(() => {
                if (document.body.contains(modal)) {
                    document.body.removeChild(modal);
                }
            }, 3000);
        }

        // é—œé–‰æˆèªè§£é‡‹å½ˆçª—
        function closeIdiomModal() {
            const modal = document.querySelector('.idiom-modal');
            if (modal && document.body.contains(modal)) {
                document.body.removeChild(modal);
            }
        }
        const tiles = {
            // è¬å­ (1-9) - ä»¥æ•¸å­—é–‹é ­çš„å‰ç¥¥æˆèª
            man: [
                {symbol: 'ä¸€å¸†é¢¨é †', name: 'ä¸€è¬', value: 1},
                {symbol: 'äºŒé¾æˆ²ç ', name: 'äºŒè¬', value: 2},
                {symbol: 'ä¸‰ç¾Šé–‹æ³°', name: 'ä¸‰è¬', value: 3},
                {symbol: 'å››å­£å¹³å®‰', name: 'å››è¬', value: 4},
                {symbol: 'äº”ç¦è‡¨é–€', name: 'äº”è¬', value: 5},
                {symbol: 'å…­å…­å¤§é †', name: 'å…­è¬', value: 6},
                {symbol: 'ä¸ƒæ˜Ÿé«˜ç…§', name: 'ä¸ƒè¬', value: 7},
                {symbol: 'å…«æ–¹ä¾†è²¡', name: 'å…«è¬', value: 8},
                {symbol: 'ä¹ä¹æ­¸ä¸€', name: 'ä¹è¬', value: 9}
            ],
            // ç­’å­ (1-9) - ä»¥æ•¸å­—é–‹é ­çš„æˆèª
            pin: [
                {symbol: 'ä¸€å…ƒå¾©å§‹', name: 'ä¸€ç­’', value: 1},
                {symbol: 'äºŒè©±ä¸èªª', name: 'äºŒç­’', value: 2},
                {symbol: 'ä¸‰ç”Ÿæœ‰å¹¸', name: 'ä¸‰ç­’', value: 3},
                {symbol: 'å››é€šå…«é”', name: 'å››ç­’', value: 4},
                {symbol: 'äº”ç©€è±ç™»', name: 'äº”ç­’', value: 5},
                {symbol: 'å…­åˆåŒæ˜¥', name: 'å…­ç­’', value: 6},
                {symbol: 'ä¸ƒç¦é½Šå¤©', name: 'ä¸ƒç­’', value: 7},
                {symbol: 'å…«é¢ç²ç“', name: 'å…«ç­’', value: 8},
                {symbol: 'ä¹éœ„é›²å¤–', name: 'ä¹ç­’', value: 9}
            ],
            // ç´¢å­ (1-9) - ä»¥æ•¸å­—é–‹é ­çš„æˆèª
            sou: [
                {symbol: 'ä¸€ç®­é›™éµ°', name: 'ä¸€ç´¢', value: 1},
                {symbol: 'äºŒäººåŒå¿ƒ', name: 'äºŒç´¢', value: 2},
                {symbol: 'ä¸‰æ€è€Œè¡Œ', name: 'ä¸‰ç´¢', value: 3},
                {symbol: 'å››æµ·å‡å¹³', name: 'å››ç´¢', value: 4},
                {symbol: 'äº”å½©ç¹½ç´›', name: 'äº”ç´¢', value: 5},
                {symbol: 'å…­è—ç²¾é€š', name: 'å…­ç´¢', value: 6},
                {symbol: 'ä¸ƒç«…ç²ç“', name: 'ä¸ƒç´¢', value: 7},
                {symbol: 'å…«æ–—ä¹‹æ‰', name: 'å…«ç´¢', value: 8},
                {symbol: 'ä¹å¤©æ”¬æœˆ', name: 'ä¹ç´¢', value: 9}
            ],
            // å­—ç‰Œ - æ–¹ä½å’Œé¡è‰²ç›¸é—œæˆèª
            honor: [
                {symbol: 'æ±é¢¨å¾—æ„', name: 'æ±', value: 10},
                {symbol: 'å—å±±å£½æ¯”', name: 'å—', value: 11},
                {symbol: 'è¥¿çª—å‰ªç‡­', name: 'è¥¿', value: 12},
                {symbol: 'åŒ—æ–—æŒ‡è·¯', name: 'åŒ—', value: 13},
                {symbol: 'ä¸­æµç ¥æŸ±', name: 'ä¸­', value: 14},
                {symbol: 'ç™¼æšå…‰å¤§', name: 'ç™¼', value: 15},
                {symbol: 'ç™½ç’§ç„¡ç‘•', name: 'ç™½', value: 16}
            ]
        };

        // éŠæˆ²ç‹€æ…‹
        let gameState = {
            currentPlayer: 0,
            players: [[], [], [], []], // ç©å®¶æ‰‹ç‰Œ
            melds: [[], [], [], []], // ç©å®¶å‰¯éœ²
            discardedTiles: [],
            remainingTiles: [],
            selectedTile: null,
            round: 'æ±ä¸€å±€',
            phase: 'normal', // normal, waiting-action
            lastDiscardedTile: null,
            lastDiscardedPlayer: null,
            waitingPlayer: null,
            availableActions: []
        };

        // åˆå§‹åŒ–ç‰Œå †
        function initializeTiles() {
            const deck = [];
            Object.entries(tiles).forEach(([category, tileList]) => {
                tileList.forEach(tile => {
                    for (let i = 0; i < 4; i++) {
                        deck.push({...tile, category});
                    }
                });
            });
            
            // æ´—ç‰Œ
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
            
            gameState.remainingTiles = deck;
        }

        // ç™¼ç‰Œ
        function dealTiles() {
            gameState.players = [[], [], [], []];
            gameState.melds = [[], [], [], []];
            
            for (let player = 0; player < 4; player++) {
                for (let i = 0; i < 13; i++) {
                    if (gameState.remainingTiles.length > 0) {
                        gameState.players[player].push(gameState.remainingTiles.pop());
                    }
                }
                sortHand(player);
            }
            
            updateDisplay();
        }

        // æ’åºæ‰‹ç‰Œ
        function sortHand(player) {
            gameState.players[player].sort((a, b) => {
                if (a.category !== b.category) {
                    const order = ['man', 'pin', 'sou', 'honor'];
                    return order.indexOf(a.category) - order.indexOf(b.category);
                }
                return a.value - b.value;
            });
        }

        // å‰µå»ºç‰Œé¢å…ƒç´ 
        function createTileElement(tile, isBack = false, isMeld = false) {
            const tileElement = document.createElement('div');
            
            if (isBack) {
                tileElement.className = 'tile tile-back';
                tileElement.innerHTML = ''; // ç‰ŒèƒŒé¢ä¸é¡¯ç¤ºæ–‡å­—
            } else {
                tileElement.className = `tile ${tile.category}`;
                if (isMeld) tileElement.classList.add('meld-tile');
                
                // å°‡å››å­—æˆèªåˆ†æˆå…©è¡Œé¡¯ç¤º
                const text = tile.symbol;
                const firstLine = text.substring(0, 2);
                const secondLine = text.substring(2, 4);
                
                tileElement.innerHTML = `<div class="tile-text">${firstLine}<br>${secondLine}</div>`;
            }
            
            return tileElement;
        }

        // å‰µå»ºæ£„ç‰Œå…ƒç´ 
        function createDiscardedTileElement(tile, isLatest = false) {
            const tileElement = document.createElement('div');
            tileElement.className = `discarded-tile ${tile.category}`;
            if (isLatest) tileElement.classList.add('latest');
            
            // å°‡å››å­—æˆèªåˆ†æˆå…©è¡Œé¡¯ç¤º
            const text = tile.symbol;
            const firstLine = text.substring(0, 2);
            const secondLine = text.substring(2, 4);
            
            tileElement.innerHTML = `<div class="discarded-text">${firstLine}<br>${secondLine}</div>`;
            return tileElement;
        }

        // æ›´æ–°é¡¯ç¤º
        function updateDisplay() {
            // æ›´æ–°ç©å®¶æ‰‹ç‰Œå’Œå‰¯éœ²
            for (let player = 0; player < 4; player++) {
                const handElement = document.getElementById(`hand-${player}`);
                const meldsElement = document.getElementById(`melds-${player}`);
                const countElement = document.getElementById(`count-${player}`);
                const meldCountElement = document.getElementById(`meld-count-${player}`);
                
                // æ¸…ç©ºç¾æœ‰å…§å®¹
                handElement.innerHTML = '';
                meldsElement.innerHTML = '';
                
                // é¡¯ç¤ºå‰¯éœ²
                gameState.melds[player].forEach(meld => {
                    const meldDiv = document.createElement('div');
                    meldDiv.className = 'meld';
                    meld.tiles.forEach(tile => {
                        const tileElement = createTileElement(tile, false, true);
                        meldDiv.appendChild(tileElement);
                    });
                    meldsElement.appendChild(meldDiv);
                });
                
                // é¡¯ç¤ºæ‰‹ç‰Œ
                if (player === 0) {
                    gameState.players[player].forEach((tile, index) => {
                        const tileElement = createTileElement(tile);
                        tileElement.onclick = () => selectTile(player, index);
                        handElement.appendChild(tileElement);
                    });
                } else {
                    gameState.players[player].forEach(() => {
                        const tileElement = createTileElement(null, true);
                        handElement.appendChild(tileElement);
                    });
                }
                
                countElement.textContent = gameState.players[player].length;
                meldCountElement.textContent = gameState.melds[player].length;
            }
            
            // æ›´æ–°æ£„ç‰Œå€ï¼ˆé™åˆ¶é¡¯ç¤ºæ•¸é‡é¿å…é®æ“‹ï¼‰
            const discardedElement = document.getElementById('discarded-tiles');
            discardedElement.innerHTML = '';
            const maxDiscardedTiles = 12; // é™åˆ¶æœ€å¤§é¡¯ç¤ºæ•¸é‡
            const tilesToShow = gameState.discardedTiles.slice(-maxDiscardedTiles);
            
            tilesToShow.forEach((tile, index) => {
                const isLatest = index === tilesToShow.length - 1 && index === gameState.discardedTiles.length - 1;
                const tileElement = createDiscardedTileElement(tile, isLatest);
                discardedElement.appendChild(tileElement);
            });
            
            // æ›´æ–°éŠæˆ²ç‹€æ…‹
            document.getElementById('remaining-tiles').textContent = gameState.remainingTiles.length;
            document.getElementById('current-turn').textContent = `ç©å®¶ ${gameState.currentPlayer + 1}`;
            document.getElementById('round').textContent = gameState.round;
            document.getElementById('game-phase').textContent = 
                gameState.phase === 'waiting-action' ? 'ç­‰å¾…å‹•ä½œé¸æ“‡' : 'æ­£å¸¸å›åˆ';
            
            // æ›´æ–°ç•¶å‰ç©å®¶é«˜äº®
            for (let i = 0; i < 4; i++) {
                const playerElement = document.getElementById(`player-${i}`);
                if (i === gameState.currentPlayer && gameState.phase === 'normal') {
                    playerElement.classList.add('current-player');
                } else {
                    playerElement.classList.remove('current-player');
                }
            }
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            updateButtonStates();
        }

        // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
        function updateButtonStates() {
            const drawBtn = document.getElementById('draw-btn');
            const discardBtn = document.getElementById('discard-btn');
            const winBtn = document.getElementById('win-btn');
            const actionButtons = document.getElementById('action-buttons');
            
            if (gameState.phase === 'waiting-action') {
                drawBtn.disabled = true;
                discardBtn.disabled = true;
                winBtn.disabled = true;
                actionButtons.classList.remove('hidden');
            } else if (gameState.phase === 'game-over') {
                drawBtn.disabled = true;
                discardBtn.disabled = true;
                winBtn.disabled = true;
                actionButtons.classList.add('hidden');
            } else {
                drawBtn.disabled = gameState.currentPlayer !== 0;
                discardBtn.disabled = gameState.currentPlayer !== 0 || gameState.selectedTile === null;
                winBtn.disabled = gameState.currentPlayer !== 0;
                actionButtons.classList.add('hidden');
            }
        }

        // æª¢æŸ¥åƒç‰Œå¯èƒ½æ€§
        function checkChi(player, discardedTile) {
            if (discardedTile.category === 'honor') return false;
            if ((gameState.lastDiscardedPlayer + 1) % 4 !== player) return false; // åªèƒ½åƒä¸Šå®¶çš„ç‰Œ
            
            const hand = gameState.players[player];
            const value = discardedTile.value;
            
            // æª¢æŸ¥å¯èƒ½çš„é †å­çµ„åˆ
            const combinations = [];
            
            // ABCå‹ (discarded, +1, +2)
            if (value <= 7) {
                const tile1 = hand.find(t => t.category === discardedTile.category && t.value === value + 1);
                const tile2 = hand.find(t => t.category === discardedTile.category && t.value === value + 2);
                if (tile1 && tile2) {
                    combinations.push([discardedTile, tile1, tile2]);
                }
            }
            
            // BACå‹ (-1, discarded, +1)
            if (value >= 2 && value <= 8) {
                const tile1 = hand.find(t => t.category === discardedTile.category && t.value === value - 1);
                const tile2 = hand.find(t => t.category === discardedTile.category && t.value === value + 1);
                if (tile1 && tile2) {
                    combinations.push([tile1, discardedTile, tile2]);
                }
            }
            
            // CBAå‹ (-2, -1, discarded)
            if (value >= 3) {
                const tile1 = hand.find(t => t.category === discardedTile.category && t.value === value - 2);
                const tile2 = hand.find(t => t.category === discardedTile.category && t.value === value - 1);
                if (tile1 && tile2) {
                    combinations.push([tile1, tile2, discardedTile]);
                }
            }
            
            return combinations.length > 0 ? combinations : false;
        }

        // æª¢æŸ¥ç¢°ç‰Œå¯èƒ½æ€§
        function checkPon(player, discardedTile) {
            const hand = gameState.players[player];
            const sameCards = hand.filter(tile => 
                tile.category === discardedTile.category && 
                tile.value === discardedTile.value
            );
            return sameCards.length >= 2 ? sameCards.slice(0, 2) : false;
        }

        // æª¢æŸ¥æ§“ç‰Œå¯èƒ½æ€§
        function checkKan(player, discardedTile) {
            const hand = gameState.players[player];
            const sameCards = hand.filter(tile => 
                tile.category === discardedTile.category && 
                tile.value === discardedTile.value
            );
            return sameCards.length >= 3 ? sameCards.slice(0, 3) : false;
        }

        // æ‰“ç‰Œå¾Œæª¢æŸ¥å…¶ä»–ç©å®¶å‹•ä½œ
        function checkActions(discardedTile, discardedPlayer) {
            gameState.lastDiscardedTile = discardedTile;
            gameState.lastDiscardedPlayer = discardedPlayer;
            gameState.availableActions = [];
            
            // æª¢æŸ¥å…¶ä»–ç©å®¶çš„å‹•ä½œå¯èƒ½æ€§
            for (let i = 1; i < 4; i++) {
                const player = (discardedPlayer + i) % 4;
                if (player === 0) { // åªè™•ç†ç©å®¶çš„å‹•ä½œ
                    
                    // å…ˆæª¢æŸ¥æ˜¯å¦èƒ½èƒ¡ç‰Œï¼ˆå„ªå…ˆç´šæœ€é«˜ï¼‰
                    // è‡¨æ™‚å°‡æ£„ç‰ŒåŠ å…¥æ‰‹ç‰Œæª¢æŸ¥èƒ¡ç‰Œ
                    gameState.players[player].push(discardedTile);
                    const canWin = checkWin(player);
                    gameState.players[player].pop(); // ç§»é™¤è‡¨æ™‚åŠ å…¥çš„ç‰Œ
                    
                    if (canWin) {
                        // å¦‚æœèƒ½èƒ¡ç‰Œï¼Œå…ˆæ’­æ”¾éŸ³æ•ˆå’Œç‰¹æ•ˆ
                        soundSystem.playWinSound();
                        fireworkSystem.celebrate();
                        
                        // æ­£å¼åŠ å…¥æ‰‹ç‰Œå’Œç§»é™¤æ£„ç‰Œ
                        gameState.players[player].push(discardedTile);
                        gameState.discardedTiles.pop();
                        
                        // é¡¯ç¤ºèƒ¡ç‰Œçš„æˆèªè§£é‡‹
                        setTimeout(() => {
                            showIdiomExplanation(discardedTile);
                        }, 500);
                        
                        // å»¶é²é¡¯ç¤ºå‹åˆ©æ¶ˆæ¯
                        setTimeout(() => {
                            const message = document.createElement('div');
                            message.className = 'message';
                            message.style.fontSize = '24px';
                            message.style.background = 'rgba(231, 76, 60, 0.95)';
                            message.style.color = '#fff';
                            message.style.padding = '30px';
                            message.textContent = 'ğŸ‰ æ‚¨èƒ¡ç‰Œäº†ï¼ğŸ‰';
                            document.body.appendChild(message);
                            
                            setTimeout(() => {
                                if (document.body.contains(message)) {
                                    document.body.removeChild(message);
                                }
                            }, 4000);
                        }, 1500);
                        
                        gameState.phase = 'game-over';
                        updateDisplay();
                        return true;
                    }
                    
                    // å¦‚æœä¸èƒ½èƒ¡ç‰Œï¼Œå†æª¢æŸ¥åƒç¢°æ§“
                    const actions = [];
                    
                    const chiPossible = checkChi(player, discardedTile);
                    const ponPossible = checkPon(player, discardedTile);
                    const kanPossible = checkKan(player, discardedTile);
                    
                    if (chiPossible) actions.push({type: 'chi', combinations: chiPossible});
                    if (ponPossible) actions.push({type: 'pon', tiles: ponPossible});
                    if (kanPossible) actions.push({type: 'kan', tiles: kanPossible});
                    
                    if (actions.length > 0) {
                        gameState.availableActions = actions;
                        gameState.waitingPlayer = player;
                        gameState.phase = 'waiting-action';
                        showActionButtons();
                        updateDisplay();
                        return true;
                    }
                }
            }
            
            return false;
        }

        // é¡¯ç¤ºå‹•ä½œæŒ‰éˆ•
        function showActionButtons() {
            const chiBtn = document.getElementById('chi-btn');
            const ponBtn = document.getElementById('pon-btn');
            const kanBtn = document.getElementById('kan-btn');
            
            chiBtn.classList.add('hidden');
            ponBtn.classList.add('hidden');
            kanBtn.classList.add('hidden');
            
            gameState.availableActions.forEach(action => {
                if (action.type === 'chi') chiBtn.classList.remove('hidden');
                if (action.type === 'pon') ponBtn.classList.remove('hidden');
                if (action.type === 'kan') kanBtn.classList.remove('hidden');
            });
        }

        // åŸ·è¡Œåƒç‰Œ
        function performChi() {
            const action = gameState.availableActions.find(a => a.type === 'chi');
            if (!action) return;

            // æ’­æ”¾åƒç‰ŒéŸ³æ•ˆ
            soundSystem.playChiSound();
            
            // ä½¿ç”¨ç¬¬ä¸€å€‹çµ„åˆï¼ˆå¯¦éš›éŠæˆ²ä¸­æ‡‰è©²è®“ç©å®¶é¸æ“‡ï¼‰
            const combination = action.combinations[0];
            const player = gameState.waitingPlayer;
            
            // é¡¯ç¤ºåƒåˆ°ç‰Œçš„æˆèªè§£é‡‹
            showIdiomExplanation(gameState.lastDiscardedTile);
            
            // å¾æ‰‹ç‰Œä¸­ç§»é™¤ç›¸æ‡‰çš„ç‰Œ
            combination.forEach(tile => {
                if (tile !== gameState.lastDiscardedTile) {
                    const index = gameState.players[player].findIndex(t => 
                        t.category === tile.category && t.value === tile.value
                    );
                    if (index !== -1) {
                        gameState.players[player].splice(index, 1);
                    }
                }
            });
            
            // ç§»é™¤æ£„ç‰Œ
            gameState.discardedTiles.pop();
            
            // æ·»åŠ åˆ°å‰¯éœ²
            gameState.melds[player].push({
                type: 'chi',
                tiles: combination
            });
            
            // ç•¶å‰ç©å®¶è®Šæ›´
            gameState.currentPlayer = player;
            gameState.phase = 'normal';
            
            // æª¢æŸ¥æ˜¯å¦èƒ¡ç‰Œ
            if (autoCheckWin(player)) return;
            
            showMessage('åƒç‰ŒæˆåŠŸï¼');
            updateDisplay();
        }

        // åŸ·è¡Œç¢°ç‰Œ
        function performPon() {
            const action = gameState.availableActions.find(a => a.type === 'pon');
            if (!action) return;

            // æ’­æ”¾ç¢°ç‰ŒéŸ³æ•ˆ
            soundSystem.playPonSound();
            
            const player = gameState.waitingPlayer;
            const tilesNeeded = action.tiles;
            
            // é¡¯ç¤ºç¢°åˆ°ç‰Œçš„æˆèªè§£é‡‹
            showIdiomExplanation(gameState.lastDiscardedTile);
            
            // å¾æ‰‹ç‰Œä¸­ç§»é™¤ç›¸æ‡‰çš„ç‰Œ
            tilesNeeded.forEach(tile => {
                const index = gameState.players[player].findIndex(t => 
                    t.category === tile.category && t.value === tile.value
                );
                if (index !== -1) {
                    gameState.players[player].splice(index, 1);
                }
            });
            
            // ç§»é™¤æ£„ç‰Œ
            const discardedTile = gameState.discardedTiles.pop();
            
            // æ·»åŠ åˆ°å‰¯éœ²
            gameState.melds[player].push({
                type: 'pon',
                tiles: [discardedTile, ...tilesNeeded]
            });
            
            // ç•¶å‰ç©å®¶è®Šæ›´
            gameState.currentPlayer = player;
            gameState.phase = 'normal';
            
            // æª¢æŸ¥æ˜¯å¦èƒ¡ç‰Œ
            if (autoCheckWin(player)) return;
            
            showMessage('ç¢°ç‰ŒæˆåŠŸï¼');
            updateDisplay();
        }

        // åŸ·è¡Œæ§“ç‰Œ
        function performKan() {
            const action = gameState.availableActions.find(a => a.type === 'kan');
            if (!action) return;

            // æ’­æ”¾æ§“ç‰ŒéŸ³æ•ˆ
            soundSystem.playKanSound();
            
            const player = gameState.waitingPlayer;
            const tilesNeeded = action.tiles;
            
            // é¡¯ç¤ºæ§“åˆ°ç‰Œçš„æˆèªè§£é‡‹
            showIdiomExplanation(gameState.lastDiscardedTile);
            
            // å¾æ‰‹ç‰Œä¸­ç§»é™¤ç›¸æ‡‰çš„ç‰Œ
            tilesNeeded.forEach(tile => {
                const index = gameState.players[player].findIndex(t => 
                    t.category === tile.category && t.value === tile.value
                );
                if (index !== -1) {
                    gameState.players[player].splice(index, 1);
                }
            });
            
            // ç§»é™¤æ£„ç‰Œ
            const discardedTile = gameState.discardedTiles.pop();
            
            // æ·»åŠ åˆ°å‰¯éœ²
            gameState.melds[player].push({
                type: 'kan',
                tiles: [discardedTile, ...tilesNeeded]
            });
            
            // æ§“ç‰Œå¾Œè£œç‰Œ
            if (gameState.remainingTiles.length > 0) {
                const newTile = gameState.remainingTiles.pop();
                gameState.players[player].push(newTile);
                sortHand(player);
                
                // é¡¯ç¤ºè£œç‰Œçš„æˆèªè§£é‡‹
                setTimeout(() => {
                    showIdiomExplanation(newTile);
                }, 1000);
            }
            
            // ç•¶å‰ç©å®¶è®Šæ›´
            gameState.currentPlayer = player;
            gameState.phase = 'normal';
            
            // æª¢æŸ¥æ˜¯å¦èƒ¡ç‰Œ
            if (autoCheckWin(player)) return;
            
            showMessage('æ§“ç‰ŒæˆåŠŸï¼è£œä¸€å¼µç‰Œ');
            updateDisplay();
        }

        // æª¢æŸ¥èƒ¡ç‰Œ
        function checkWin(player) {
            const hand = [...gameState.players[player]];
            const melds = gameState.melds[player];
            
            // ç¸½ç‰Œæ•¸æª¢æŸ¥ï¼ˆæ‰‹ç‰Œ + å‰¯éœ²æ‡‰è©²æ˜¯14å¼µï¼‰
            const totalTiles = hand.length + melds.reduce((sum, meld) => sum + meld.tiles.length, 0);
            if (totalTiles !== 14) return false;
            
            // å‰¯éœ²å·²ç¶“æ˜¯å®Œæˆçš„é¢å­ï¼Œåªéœ€æª¢æŸ¥æ‰‹ç‰Œéƒ¨åˆ†
            const meldCount = melds.length;
            const requiredPairs = 1;
            const requiredMelds = 4 - meldCount;
            
            return canFormWinningHand(hand, requiredMelds, requiredPairs);
        }

        // æª¢æŸ¥æ˜¯å¦èƒ½çµ„æˆèƒ¡ç‰Œæ‰‹ç‰Œ
        function canFormWinningHand(tiles, needMelds, needPairs) {
            if (needMelds === 0 && needPairs === 0) {
                return tiles.length === 0;
            }
            
            if (tiles.length === 0) {
                return needMelds === 0 && needPairs === 0;
            }
            
            // å˜—è©¦çµ„æˆå°å­
            if (needPairs > 0) {
                for (let i = 0; i < tiles.length - 1; i++) {
                    if (tiles[i].category === tiles[i + 1].category && 
                        tiles[i].value === tiles[i + 1].value) {
                        
                        const remaining = [...tiles];
                        remaining.splice(i, 2);
                        
                        if (canFormWinningHand(remaining, needMelds, needPairs - 1)) {
                            return true;
                        }
                    }
                }
            }
            
            // å˜—è©¦çµ„æˆåˆ»å­
            if (needMelds > 0) {
                for (let i = 0; i < tiles.length - 2; i++) {
                    if (tiles[i].category === tiles[i + 1].category && 
                        tiles[i].value === tiles[i + 1].value &&
                        tiles[i].category === tiles[i + 2].category && 
                        tiles[i].value === tiles[i + 2].value) {
                        
                        const remaining = [...tiles];
                        remaining.splice(i, 3);
                        
                        if (canFormWinningHand(remaining, needMelds - 1, needPairs)) {
                            return true;
                        }
                    }
                }
                
                // å˜—è©¦çµ„æˆé †å­ï¼ˆåªæœ‰æ•¸å­—ç‰Œï¼‰
                for (let i = 0; i < tiles.length; i++) {
                    if (tiles[i].category !== 'honor' && tiles[i].value <= 7) {
                        // å°‹æ‰¾é€£çºŒçš„ä¸‰å¼µç‰Œ
                        const tile1 = tiles[i];
                        let tile2Index = -1, tile3Index = -1;
                        
                        for (let j = i + 1; j < tiles.length; j++) {
                            if (tiles[j].category === tile1.category && tiles[j].value === tile1.value + 1) {
                                tile2Index = j;
                                break;
                            }
                        }
                        
                        if (tile2Index !== -1) {
                            for (let k = tile2Index + 1; k < tiles.length; k++) {
                                if (tiles[k].category === tile1.category && tiles[k].value === tile1.value + 2) {
                                    tile3Index = k;
                                    break;
                                }
                            }
                        }
                        
                        if (tile2Index !== -1 && tile3Index !== -1) {
                            const remaining = [...tiles];
                            remaining.splice(tile3Index, 1);
                            remaining.splice(tile2Index, 1);
                            remaining.splice(i, 1);
                            
                            if (canFormWinningHand(remaining, needMelds - 1, needPairs)) {
                                return true;
                            }
                        }
                    }
                }
            }
            
            return false;
        }

        // ç©å®¶ä¸»å‹•æª¢æŸ¥èƒ¡ç‰Œ
        function checkPlayerWin() {
            if (gameState.currentPlayer !== 0) return;
            
            if (checkWin(0)) {
                // æ’­æ”¾éŸ³æ•ˆå’Œç‰¹æ•ˆ
                soundSystem.playWinSound();
                fireworkSystem.celebrate();
                
                // å¦‚æœèƒ¡ç‰Œï¼Œé¡¯ç¤ºæœ€å¾ŒæŠ“åˆ°çš„ç‰Œçš„è§£é‡‹
                const lastTile = gameState.players[0][gameState.players[0].length - 1];
                setTimeout(() => {
                    showIdiomExplanation(lastTile);
                }, 500);
                
                // å»¶é²é¡¯ç¤ºå‹åˆ©æ¶ˆæ¯
                setTimeout(() => {
                    const message = document.createElement('div');
                    message.className = 'message';
                    message.style.fontSize = '24px';
                    message.style.background = 'rgba(231, 76, 60, 0.95)';
                    message.style.color = '#fff';
                    message.style.padding = '30px';
                    message.textContent = 'ğŸ‰ æ­å–œèƒ¡ç‰Œï¼ğŸ‰';
                    document.body.appendChild(message);
                    
                    setTimeout(() => {
                        if (document.body.contains(message)) {
                            document.body.removeChild(message);
                        }
                    }, 4000);
                }, 1500);
                
                gameState.phase = 'game-over';
                updateDisplay();
            } else {
                showMessage('é‚„æ²’æœ‰èƒ¡ç‰Œï¼Œç¹¼çºŒåŠªåŠ›ï¼');
            }
        }

        // é¡¯ç¤ºèƒœåˆ©æ¶ˆæ¯ï¼ˆä¿ç•™ç”¨æ–¼éç©å®¶èƒ¡ç‰Œæƒ…æ³ï¼‰
        function showWinMessage(text) {
            const message = document.createElement('div');
            message.className = 'message';
            message.style.fontSize = '24px';
            message.style.background = 'rgba(231, 76, 60, 0.95)';
            message.style.color = '#fff';
            message.style.padding = '30px';
            message.textContent = text;
            document.body.appendChild(message);
            
            setTimeout(() => {
                if (document.body.contains(message)) {
                    document.body.removeChild(message);
                }
            }, 4000);
        }

        // è‡ªå‹•æª¢æŸ¥èƒ¡ç‰Œï¼ˆåœ¨æŠ“ç‰Œæˆ–åƒç¢°æ§“å¾Œï¼‰
        function autoCheckWin(player) {
            if (checkWin(player)) {
                const playerName = player === 0 ? 'æ‚¨' : `ç©å®¶ ${player + 1}`;
                
                if (player === 0) {
                    // ç©å®¶èƒ¡ç‰Œï¼šæ’­æ”¾éŸ³æ•ˆå’Œç‰¹æ•ˆ
                    soundSystem.playWinSound();
                    fireworkSystem.celebrate();
                    
                    const lastTile = gameState.players[0][gameState.players[0].length - 1];
                    setTimeout(() => {
                        showIdiomExplanation(lastTile);
                    }, 500);
                    
                    // å»¶é²é¡¯ç¤ºå‹åˆ©æ¶ˆæ¯
                    setTimeout(() => {
                        const message = document.createElement('div');
                        message.className = 'message';
                        message.style.fontSize = '24px';
                        message.style.background = 'rgba(231, 76, 60, 0.95)';
                        message.style.color = '#fff';
                        message.style.padding = '30px';
                        message.textContent = `ğŸ‰ ${playerName} èƒ¡ç‰Œäº†ï¼ğŸ‰`;
                        document.body.appendChild(message);
                        
                        setTimeout(() => {
                            if (document.body.contains(message)) {
                                document.body.removeChild(message);
                            }
                        }, 4000);
                    }, 1500);
                } else {
                    // AI èƒ¡ç‰Œï¼šåªé¡¯ç¤ºæ¶ˆæ¯
                    const message = document.createElement('div');
                    message.className = 'message';
                    message.style.fontSize = '20px';
                    message.style.background = 'rgba(52, 152, 219, 0.9)';
                    message.style.color = '#fff';
                    message.style.padding = '25px';
                    message.textContent = `ğŸ‰ ${playerName} èƒ¡ç‰Œäº†ï¼ğŸ‰`;
                    document.body.appendChild(message);
                    
                    setTimeout(() => {
                        if (document.body.contains(message)) {
                            document.body.removeChild(message);
                        }
                    }, 3000);
                }
                
                gameState.phase = 'game-over';
                return true;
            }
            return false;
        }
        function skipAction() {
            gameState.phase = 'normal';
            // ä¸‹ä¸€ä½ç©å®¶
            gameState.currentPlayer = (gameState.lastDiscardedPlayer + 1) % 4;
            updateDisplay();
            
            // AI è‡ªå‹•é€²è¡Œ
            if (gameState.currentPlayer !== 0) {
                setTimeout(() => {
                    aiPlay();
                }, 1000);
            }
        }

        // é¡¯ç¤ºæ¶ˆæ¯
        function showMessage(text) {
            const message = document.createElement('div');
            message.className = 'message';
            message.textContent = text;
            document.body.appendChild(message);
            
            setTimeout(() => {
                document.body.removeChild(message);
            }, 2000);
        }

        // é¸æ“‡ç‰Œ
        function selectTile(player, index) {
            if (player !== gameState.currentPlayer || player !== 0 || gameState.phase !== 'normal') return;
            
            document.querySelectorAll('.tile.selected').forEach(tile => {
                tile.classList.remove('selected');
            });
            
            const tileElements = document.getElementById(`hand-${player}`).children;
            if (tileElements[index]) {
                tileElements[index].classList.add('selected');
                gameState.selectedTile = index;
            }
            
            updateDisplay();
        }

        // æ‰“ç‰Œ
        function discardSelected() {
            if (gameState.selectedTile === null || gameState.currentPlayer !== 0 || gameState.phase !== 'normal') return;
            
            // æ’­æ”¾æ‰“ç‰ŒéŸ³æ•ˆ
            soundSystem.playDiscardSound();
            
            const tile = gameState.players[0].splice(gameState.selectedTile, 1)[0];
            gameState.discardedTiles.push(tile);
            gameState.selectedTile = null;
            
            // é¡¯ç¤ºæ‰“å‡ºç‰Œçš„æˆèªè§£é‡‹
            showIdiomExplanation(tile);
            
            // æª¢æŸ¥å…¶ä»–ç©å®¶æ˜¯å¦æœ‰å‹•ä½œ
            if (!checkActions(tile, 0)) {
                // æ²’æœ‰å‹•ä½œï¼Œæ­£å¸¸é€²è¡Œä¸‹ä¸€ä½
                nextPlayer();
            }
            
            updateDisplay();
        }

        // æŠ“ç‰Œ
        function drawTile() {
            if (gameState.remainingTiles.length === 0 || gameState.currentPlayer !== 0 || gameState.phase !== 'normal') return;
            
            // æ’­æ”¾æŠ“ç‰ŒéŸ³æ•ˆ
            soundSystem.playDrawSound();
            
            const tile = gameState.remainingTiles.pop();
            gameState.players[0].push(tile);
            sortHand(0);
            
            // é¡¯ç¤ºæŠ“åˆ°ç‰Œçš„æˆèªè§£é‡‹
            showIdiomExplanation(tile);
            
            // æª¢æŸ¥æ˜¯å¦èƒ¡ç‰Œ
            if (autoCheckWin(0)) return;
            
            updateDisplay();
        }

        // ä¸‹ä¸€ä½ç©å®¶
        function nextPlayer() {
            gameState.currentPlayer = (gameState.currentPlayer + 1) % 4;
            
            if (gameState.currentPlayer !== 0) {
                setTimeout(() => {
                    aiPlay();
                }, 1000);
            }
        }

        // AI ç©å®¶é‚è¼¯
        function aiPlay() {
            const player = gameState.currentPlayer;
            
            // AI æŠ“ç‰Œ
            if (gameState.remainingTiles.length > 0) {
                const tile = gameState.remainingTiles.pop();
                gameState.players[player].push(tile);
            }
            
            // AI æ‰“ç‰Œ
            if (gameState.players[player].length > 0) {
                const randomIndex = Math.floor(Math.random() * gameState.players[player].length);
                const discardedTile = gameState.players[player].splice(randomIndex, 1)[0];
                gameState.discardedTiles.push(discardedTile);
                
                // æª¢æŸ¥ç©å®¶æ˜¯å¦æœ‰å‹•ä½œ
                if (!checkActions(discardedTile, player)) {
                    nextPlayer();
                }
            } else {
                nextPlayer();
            }
            
            updateDisplay();
        }

        // å‰µå»ºéª°å­é»æ•¸
        function createDiceDots(number) {
            const patterns = {
                1: [4], 2: [0, 8], 3: [0, 4, 8], 4: [0, 2, 6, 8], 
                5: [0, 2, 4, 6, 8], 6: [0, 2, 3, 5, 6, 8]
            };
            
            const dotsContainer = document.createElement('div');
            dotsContainer.className = 'dice-dots';
            
            for (let i = 0; i < 9; i++) {
                const dot = document.createElement('div');
                if (patterns[number].includes(i)) {
                    dot.className = 'dot';
                }
                dotsContainer.appendChild(dot);
            }
            
            return dotsContainer;
        }

        // æ“²éª°å­
        function rollDice() {
            // æ’­æ”¾æ“²éª°å­éŸ³æ•ˆ
            soundSystem.playDiceSound();
            
            const dice1 = Math.floor(Math.random() * 6) + 1;
            const dice2 = Math.floor(Math.random() * 6) + 1;
            
            document.getElementById('dice1-dots').replaceWith(createDiceDots(dice1));
            document.getElementById('dice2-dots').replaceWith(createDiceDots(dice2));
            
            setTimeout(() => {
                const dice1Element = document.querySelector('#dice1 .dice-dots');
                const dice2Element = document.querySelector('#dice2 .dice-dots');
                if (dice1Element) dice1Element.id = 'dice1-dots';
                if (dice2Element) dice2Element.id = 'dice2-dots';
            }, 100);
        }

        // æ–°å±€
        function newGame() {
            // æ’­æ”¾æ–°å±€éŸ³æ•ˆ
            soundSystem.playNewGameSound();
            
            gameState.currentPlayer = 0;
            gameState.discardedTiles = [];
            gameState.selectedTile = null;
            gameState.phase = 'normal';
            gameState.lastDiscardedTile = null;
            gameState.lastDiscardedPlayer = null;
            gameState.waitingPlayer = null;
            gameState.availableActions = [];
            
            initializeTiles();
            dealTiles();
            rollDice();
        }

        // éµç›¤äº‹ä»¶
        document.addEventListener('keydown', (event) => {
            if (event.key === ' ') {
                event.preventDefault();
                if (gameState.selectedTile !== null) {
                    discardSelected();
                }
            } else if (event.key === 'd' || event.key === 'D') {
                drawTile();
            }
        });

        // åˆå§‹åŒ–éŸ³é »ä¸Šä¸‹æ–‡ï¼ˆéœ€è¦ç”¨æˆ¶äº¤äº’ï¼‰
        document.addEventListener('click', function initAudio() {
            if (soundSystem.audioContext && soundSystem.audioContext.state === 'suspended') {
                soundSystem.audioContext.resume();
            }
            document.removeEventListener('click', initAudio);
        });

        // åˆå§‹åŒ–éŠæˆ²
        newGame();
    </script>
</body>
</html>